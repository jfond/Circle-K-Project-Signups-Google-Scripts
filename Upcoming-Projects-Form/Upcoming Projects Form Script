/* This script parses the signups from the "Submit a Project (Responses)" spreadsheet,
   and dynamically creates the signups form depending on the upcoming projects */

function inflateForm() {
  
  //var signupForm = FormApp.getActiveForm();
  var signupForm = FormApp.openById("1rnd_UjQCiSZt44jTQWdAfREx3sYgig2joyhQfbVssDs");
  var mySubmitAProjectResponsesKey = "1zoiyyOT8pwBYw16CTVO-4Bp2Tx25Koxagd_MTUiZggI";
  
  var projectItems;
  
  //Get access to the custom spreadsheet handled by the submit a project form, and take
  // a look at which projects are coming up.
  
  var activeProjectsSpreadsheetID = "1T6QaKngOqfaxf6kyLDtSdCMeATiFGF5jxlsDwE5ABNw"
  var activeProjectsSpreadsheet = SpreadsheetApp.openById(activeProjectsSpreadsheetID);
  
  var frontSheet = activeProjectsSpreadsheet.getSheets()[0];
  
  var numProjects = frontSheet.getDataRange().getHeight()-1; //Because one row is for labels
  var numParameters = frontSheet.getDataRange().getWidth();
  
  //These are the parameters we want to collect for each project
  var projectName;
  var projectLocation
  var projectChair;
  var projectChairEmail;
  var askNeedRide;
  var startDate;
  var endDate;
  
  var numShifts;
  var shiftStartTime = [];
  var shiftEndTime = [];
  
  // This is the question handle
  var myItem;
 
  // Some variables for the for-loop
  var itemTitles = [];
  var j;
  
  //For loop finds key values of each project
  for (j=0;j<numParameters;j++){
    itemTitles.push(frontSheet.getRange(1,j+2).getValue());
  }
  
  for (var i=0;i<numProjects;i++){
  
    j = itemTitles.indexOf("Event/Project Name");
    projectName = frontSheet.getRange(i+2,j+2).getValue(); 
    
    j = itemTitles.indexOf("Project Location");
    projectLocation = frontSheet.getRange(i+2,j+2).getValue();
    
    j = itemTitles.indexOf("Project Chairperson");
    projectChair = frontSheet.getRange(i+2, j+2).getValue();
    
    j = itemTitles.indexOf("Project Chairperson Email Address");
    projectChairEmail = frontSheet.getRange(i+2, j+2).getValue();
    
    j = itemTitles.indexOf("Number of Shifts");
    numShifts = parseInt(frontSheet.getRange(i+2, j+2).getValue().substr(0,1));
        
    if (numShifts == 1){
      j = itemTitles.indexOf("Project Start Date/Time")
      shiftStartTime.push(frontSheet.getRange(i+2,j+2).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+3).getValue());
    }    
    else if (numShifts == 2){
      j = itemTitles.indexOf("Shift 1 of 2 Start Time");
      shiftStartTime.push(frontSheet.getRange(i+2,j+2).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+3).getValue());
      shiftStartTime.push(frontSheet.getRange(i+2,j+4).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+5).getValue());
    }
    else if (numShifts == 3){
      j = itemTitles.indexOf("Shift 1 of 3 Start Time");
      shiftStartTime.push(frontSheet.getRange(i+2,j+2).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+3).getValue());
      shiftStartTime.push(frontSheet.getRange(i+2,j+4).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+5).getValue());
      shiftStartTime.push(frontSheet.getRange(i+2,j+6).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+7).getValue());
    }
    else if (numShifts == 4){
      j = itemTitles.indexOf("Shift 1 of 4 Start Time");
      shiftStartTime.push(frontSheet.getRange(i+2,j+2).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+3).getValue());
      shiftStartTime.push(frontSheet.getRange(i+2,j+4).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+5).getValue());
      shiftStartTime.push(frontSheet.getRange(i+2,j+6).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+7).getValue());
      shiftStartTime.push(frontSheet.getRange(i+2,j+8).getValue());
      shiftEndTime.push(frontSheet.getRange(i+2,j+9).getValue());
    }
    else{
    Logger.log("Number of Shifts Error");
    }
    
    j = itemTitles.indexOf("Ask If they Need a Ride?");
    if (frontSheet.getRange(i+2,j+2).getValue() == "Yes"){
      askNeedRide = true;
    }
    else{ 
      askNeedRide = false;
    }
  }   
  
  // For loop: Create one signup entry for every shift
  for (var n=0;n<numShifts;n++){
    myItem = signupForm.addCheckboxItem();
    //Set title. If there are multiple shifts, mention which shift it is.
    if (numShifts == 1){
      var myTitle = projectName + "     -     " + DateStringtoWords(shiftStartTime[0], shiftEndTime[0]);
    }
    else {
      var myTitle = projectName + "Shift " + n.toString() + "     -     " + DateStringtoWords(shiftStartTime[n],ShiftEndTime[n]);
    }
    myItem.setTitle(myTitle);
    
    //Set Choices
    var choiceValues = ["I am attending"];
    if (askNeedRide){
      choiceValues.push("Need Ride");
    }
    myItem.setChoiceValues(choiceValues);
    //Set help text
    var myText = "Location: " + projectLocation + ". Chair: " + projectChair + ", " + projectChairEmail;
    myItem.setHelpText(myText);
     
  }
  
}
  
function DateStringtoWords(startString, endString){
  //DateString comes in the format "MM-DD-YYYY HH:MM:SS"
  var startDate = new Date(startString);
  var endDate = new Date(endString);
  var MM = startDate.getMonth().toString(); //0-11, January is 0!
  var DD = startDate.getDate().toString();
  var YYYY = startDate.getFullYear().toString();
  var HH = startDate.getHours();//0-23
  var MINS = startDate.getMinutes();//0-59
  var hourSet = "AM";
  
  //Switch to determine the string corresponding to the month
  if (HH > 12){
    hourSet = "PM";
    HH -= 12; 
  }
  HH = HH.toString()
  if (MINS < 10){
    MINS = "0" + MINS.toString();
  }
  else{
    MINS = MINS.toString();
  }
  
  var MM2 = endDate.getMonth().toString(); //0-11, January is 0!
  var DD2 = endDate.getDate().toString();
  var YYYY2 = endDate.getFullYear().toString();
  var HH2 = endDate.getHours();//0-23
  var MINS2 = endDate.getMinutes();
  var hourSet2 = "AM";
    
  //Switch to determine the string corresponding to the month
  if (HH2 > 12){
    hourSet2 = "PM";
    HH2 -= 12; 
  }
  HH2 = HH2.toString();
  if (MINS2 < 10){
    MINS2 = "0"+MINS2.toString();
  }
  else {
    MINS2.toString();
  }
  
  var monthWord = getMonthFromInt(parseInt(MM));
  var dayWord = getDayFromInt(startDate.getDay());
  var monthWord2 = getMonthFromInt(parseInt(MM2));
  var dayWord2 = getDayFromInt(endDate.getDay());

  var Words = "Error: Date not Parsed Correctly";
  if ((YYYY==YYYY2) && (DD==DD2) && (MM==MM2)){
    Words = dayWord + ", " + monthWord + " " + DD + ", " + YYYY + " ";
    Words += HH + ":" + MINS + " " + hourSet + " - " + HH2 + ":" + MINS2 + " " + hourSet2;  
  }
  else{
    Words = dayWord + ", " + monthWord + " " + DD + ", " + YYYY + " " + HH+":"+MINS + " " + hourSet;
    Words += dayWord2 + ", " + monthWord2 + " " + DD2 + ", " + YYYY2 + " " + HH2+":"+MINS2 + " " + hourSet2;
  }
      
  return Words;  
  
}
 
function getMonthFromInt(monthInt){
 var monthWord = "Error Parsing Month";
  
  switch (monthInt){
    case 0:
      monthWord = "January";
      break;
    case 1:
      monthWord = "February";
      break;
    case 2:
      monthWord = "March";
      break;
    case 3:
      monthWord = "April";
      break;
    case 4:
      monthWord = "May";
      break;
    case 5:
      monthWord = "June";
      break;
    case 6:
      monthWord = "July";
      break;
    case 7:
      monthWord = "August";
      break;
    case 8:
      monthWord = "September";
      break;
    case 9:
      monthWord = "October";
      break;
    case 10:
      monthWord = "November";
      break;
    case 11:
      monthWord = "December";
      break;
  }
  return monthWord;
  
}

function getDayFromInt(dayInt){
   
  var dayWord = "Error Parsing Day of the Week";
  
  switch (dayInt){
    case 0:
      dayWord = "Monday";
      break;
    case 1:
      dayWord = "Tuesday";
      break;
    case 2:
      dayWord = "Wednesday";
      break;
    case 3:
      dayWord = "Thursday";
      break;
    case 4:
      dayWord = "Friday";
      break;
    case 5:
      dayWord = "Saturday";
      break;
    case 6:
      dayWord = "Sunday";
      break;
  }
  return dayWord;
}
  
  


